<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRACE: Secure Location-Based Public Health Alert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .tab-button { transition: all 0.2s; }
        .map-sim {
            height: 200px;
            background-color: #e0e7ff; /* Light indigo background */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            border: 2px solid #6366f1; /* Indigo border */
            color: #4338ca;
            font-size: 0.9rem;
        }
        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
            background-color: #3b82f6;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 4px;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="min-h-screen">

<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl font-bold text-center text-white mb-6 rounded-xl p-4 bg-indigo-700 shadow-xl">
        FRACE üá∏üá¶: Location-Based Public Health Alert System
    </h1>

    <div class="bg-white p-6 rounded-xl shadow-2xl">
        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-admin-btn" onclick="showTab('admin')" class="tab-button py-2 px-4 text-sm sm:text-base font-medium text-center focus:outline-none rounded-t-lg bg-indigo-50 text-indigo-700 border-b-2 border-indigo-500">
                1. Hospital Admin Panel (Trigger DB 1)
            </button>
            <button id="tab-mobile-btn" onclick="showTab('mobile')" class="tab-button py-2 px-4 text-sm sm:text-base font-medium text-center focus:outline-none rounded-t-lg text-gray-500 hover:text-gray-700 hover:bg-gray-50">
                2. National App Integration (User UID `A-27X-993`)
            </button>
        </div>

        <!-- Tab Content -->
        <div id="tab-admin" class="tab-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Hospital Input Database (DB 1) & Decision Tree Trigger</h2>
            <div class="space-y-4">

                <!-- Incident Type / Symptoms -->
                <div>
                    <label for="incident-type" class="block text-sm font-medium text-gray-700">Abnormal Symptom Cluster / Incident Type</label>
                    <select id="incident-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="Infectious_Flu">Confirmed Infectious Flu Cluster</option>
                        <option value="Food_Poisoning">Suspected Mass Food Poisoning</option>
                        <option value="Heat_Stroke">High Heat-Stroke Incidence</option>
                        <option value="Unknown_Hazard">Unknown Environmental Hazard</option>
                    </select>
                </div>

                <!-- Geofence Simulation -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Suspected Geofence / Risk Location</label>
                    <div class="map-sim mb-3">
                        <p class="text-lg font-mono text-gray-600">
                            <span class="text-indigo-600">üó∫Ô∏è Geofence ID:</span>
                            <select id="location-geofence" class="p-1 border border-indigo-400 rounded focus:ring-indigo-500">
                                <option value="RIYADH_CENTRAL_MARKET">Riyadh Central Market (100m radius)</option>
                                <option value="JEDDAH_CORNICHE_CAFE">Jeddah Corniche Cafe</option>
                                <option value="MECCA_ROAD_REST_STOP">Mecca Road Rest Stop (KM 50)</option>
                            </select>
                        </p>
                    </div>
                </div>

                <!-- Time Window -->
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <label for="start-time" class="block text-sm font-medium text-gray-700">Time Window Start (Hours Ago)</label>
                        <input type="number" id="start-time" value="72" min="1" max="168" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="flex-1">
                        <label for="end-time" class="block text-sm font-medium text-gray-700">Time Window End (Hours Ago)</label>
                        <input type="number" id="end-time" value="24" min="1" max="168" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>

                <button onclick="triggerAlert()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-lg font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out transform hover:scale-[1.01]" id="trigger-btn">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    EXECUTE FRACE SECURE ALERT LOGIC
                </button>

                <div id="admin-log" class="mt-4 p-4 text-sm bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-wrap">
                    FRACE System Log: Awaiting Hospital Input...
                </div>
            </div>
        </div>

        <div id="tab-mobile" class="tab-content hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">User App Simulator (Tawakkalna/Sehaty Integration)</h2>

            <div class="bg-indigo-50 border-2 border-indigo-200 p-4 rounded-xl shadow-inner mb-4">
                <p class="text-sm font-mono text-indigo-700">
                    <span class="font-bold">User UID (Anonymized):</span> `A-27X-993` (This user's location log is stored in DB 2)
                </p>
                <p class="text-xs text-indigo-500 mt-1">
                    <span class="font-bold">Privacy Note:</span> Location logs (DB 2) are automatically deleted after 24 hours (Simulated Data Minimization Policy).
                </p>
            </div>

            <div id="mobile-app-display" class="min-h-[250px] flex flex-col items-center justify-center p-6 bg-white border border-gray-200 rounded-xl shadow-lg">
                <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                <p class="text-lg text-gray-600 font-semibold" id="mobile-status">System running in background (Opt-in GPS active)...</p>
                <div class="flex mt-3" id="mobile-loading" style="display: none;">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>

            <div id="mobile-alert-notification" class="hidden mt-6 bg-red-100 border-l-4 border-red-500 p-4 rounded-lg shadow-md" role="alert">
                <p class="font-bold text-xl text-red-800">üö® IMMEDIATE PUBLIC HEALTH ALERT üö®</p>
                <p class="text-red-700 mt-2">
                    <span class="font-semibold" id="notification-time"></span>
                    <br>
                    <span id="notification-message"></span>
                    <br><br>
                    This is a verifiable alert triggered by the FRACE system via secure API integration. Please follow Ministry of Health guidance.
                </p>
                <button onclick="clearAlert()" class="mt-3 text-sm text-red-900 bg-red-300 p-1.5 rounded-md hover:bg-red-400 transition">Acknowledge & Dismiss</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SIMULATED DATABASES & ARCHITECTURE ---
    const __app_id = 'FRACE_Hackathon_Prototype';
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Simulated DB 1: Hospital Input (The "Trigger") - This is the input data
    // No explicit data structure needed here, as it comes from the form.

    // Simulated DB 2: Anonymized Location Tracking (Continuous GPS History)
    const DB_LOCATION_TRACKING = [
        // User A-27X-993 (The simulated user) was in the target geofence within the window
        { uid: "A-27X-993", geofence: "RIYADH_CENTRAL_MARKET", timestamp: Date.now() - (40 * 3600 * 1000) }, // 40 hours ago (HIT)
        // User B was outside the geofence
        { uid: "B-55Y-101", geofence: "MECCA_ROAD_REST_STOP", timestamp: Date.now() - (30 * 3600 * 1000) },
        // User C was at the target geofence, but too long ago (75 hours ago)
        { uid: "C-90Z-007", geofence: "RIYADH_CENTRAL_MARKET", timestamp: Date.now() - (75 * 3600 * 1000) }, // (MISS)
        // User D was at the target geofence, but too recent (5 hours ago)
        { uid: "D-11A-222", geofence: "RIYADH_CENTRAL_MARKET", timestamp: Date.now() - (5 * 3600 * 1000) }, // (MISS)
    ];

    // --- GLOBAL STATE ---
    let pendingAlert = null;

    document.addEventListener('DOMContentLoaded', () => {
        showTab('admin');
        document.getElementById('mobile-status').textContent = 'System Ready. Opt-in for anonymous tracking confirmed.';
    });

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-b-2', 'border-indigo-500');
            btn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-50');
        });

        const activeBtn = document.getElementById(`tab-${tabName}-btn`);
        activeBtn.classList.add('bg-indigo-50', 'text-indigo-700', 'border-b-2', 'border-indigo-500');
        activeBtn.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:bg-gray-50');
    }

    function getTimestampFromHoursAgo(hours) {
        return Date.now() - (hours * 3600 * 1000);
    }

    // --- CORE BACKEND LOGIC & DECISION TREE ---
    function triggerAlert() {
        const geofence = document.getElementById('location-geofence').value;
        const incidentType = document.getElementById('incident-type').value;
        const startTimeHours = parseInt(document.getElementById('start-time').value);
        const endTimeHours = parseInt(document.getElementById('end-time').value);

        if (startTimeHours <= endTimeHours) {
            document.getElementById('admin-log').innerHTML = '<span class="text-red-600 font-bold">Error:</span> Start time must be greater than end time (further in the past).';
            return;
        }

        const startTimestamp = getTimestampFromHoursAgo(startTimeHours);
        const endTimestamp = getTimestampFromHoursAgo(endTimeHours);

        const log = document.getElementById('admin-log');
        log.innerHTML = `<span class="font-bold text-indigo-700">Starting FRACE Execution: Incident Type [${incidentType}]...</span>\n`;
        document.getElementById('trigger-btn').disabled = true;
        document.getElementById('trigger-btn').innerHTML = '<div class="flex items-center justify-center"><div class="loading-dot bg-white"></div><div class="loading-dot bg-white"></div><div class="loading-dot bg-white"></div></div> Executing Secure Query...';

        // 1. DECISION TREE LOGIC (Bypass/Routing)
        log.innerHTML += `\n[STEP 1: Decision Tree] Analyzing Incident Type...`;
        let targetedAuthorities = ["Ministry of Health"];
        let alertLevel = "CRITICAL";

        switch(incidentType) {
            case 'Food_Poisoning':
                targetedAuthorities.push("Restaurant Regulatory Authority");
                alertLevel = "URGENT";
                log.innerHTML += `\n  -> Match: Food Poisoning. Targeting MoH & Regulatory Authority for rapid closure.`;
                break;
            case 'Heat_Stroke':
                targetedAuthorities.push("Red Crescent (Field Response)");
                alertLevel = "SAFETY";
                log.innerHTML += `\n  -> Match: Heat Stroke. Targeting Red Crescent and providing general safety guidance.`;
                break;
            case 'Infectious_Flu':
                // Default flow, only MoH needed.
                log.innerHTML += `\n  -> Match: Infectious Cluster. Standard MoH tracing protocol.`;
                break;
            default:
                log.innerHTML += `\n  -> Match: General/Unknown Hazard. Standard MoH notification.`;
        }
        log.innerHTML += `\n  -> Authorities Notified: [${targetedAuthorities.join(', ')}]`;

        // 2. SECURE LOCATION QUERY (Linking DB 1 and DB 2)
        log.innerHTML += `\n\n[STEP 2: Secure Query] Querying Location Tracking DB (DB 2) - SDAIA Compliant...`;
        log.innerHTML += `\n  -> Geofence Check: '${geofence}' between ${new Date(startTimestamp).toLocaleTimeString()} and ${new Date(endTimestamp).toLocaleTimeString()}.`;

        // Filter location history based on time and location
        const exposedRecords = DB_LOCATION_TRACKING.filter(record => {
            return record.geofence === geofence &&
                   record.timestamp >= startTimestamp &&
                   record.timestamp <= endTimestamp;
        });

        const targetedUIDs = [...new Set(exposedRecords.map(r => r.uid))];

        log.innerHTML += `\n[DB 2 Response] Found ${targetedUIDs.length} User UIDs (Anonymized IDs) in risk zone: [${targetedUIDs.join(', ')}]`;
        log.innerHTML += `\n  -> <span class="text-green-600 font-semibold">Privacy Compliance:</span> UIDs are never transferred out of the secure module. The alert is pushed anonymously.`;


        // 3. ALERT DISTRIBUTION (Simulated API Integration)
        log.innerHTML += `\n\n[STEP 3: National Integration] Sending anonymous push payload to ${targetedUIDs.length} devices...`;

        let alertMessage = "";
        switch(incidentType) {
            case 'Food_Poisoning':
                alertMessage = `You were potentially exposed to a food-borne hazard at ${geofence} during the risk window. Seek medical attention if symptoms occur.`;
                break;
            case 'Heat_Stroke':
                alertMessage = `Extreme heat conditions were reported near ${geofence} during your presence. Hydrate immediately and monitor vital signs. Red Crescent is on standby.`;
                break;
            case 'Infectious_Flu':
            case 'Unknown_Hazard':
            default:
                alertMessage = `Potential exposure to a public health risk at ${geofence}. This is an anonymous, verifiable alert. Consult Sehaty for next steps.`;
        }


        pendingAlert = {
            incidentType: incidentType,
            location: geofence,
            alertLevel: alertLevel,
            targetedUsers: targetedUIDs,
            timestamp: new Date().toLocaleTimeString(),
            message: alertMessage
        };

        // Reset button after simulation delay
        setTimeout(() => {
            document.getElementById('trigger-btn').disabled = false;
            document.getElementById('trigger-btn').innerHTML = '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z"></path></svg>EXECUTE FRACE SECURE ALERT LOGIC';
            log.innerHTML += `\n\n--- FRACE ALERT PROCESS COMPLETE ---`;

            // Auto-switch to mobile view to show the result
            showTab('mobile');
        }, 2000);
    }

    // --- MOBILE APP SIMULATION LOGIC ---

    function checkAlert() {
        const mobileId = "A-27X-993"; // The UID of the user we are simulating viewing the app
        const mobileStatus = document.getElementById('mobile-status');
        const notificationBox = document.getElementById('mobile-alert-notification');
        const loading = document.getElementById('mobile-loading');

        loading.style.display = 'flex';
        mobileStatus.textContent = 'Polling secure API for targeted alert payload...';

        setTimeout(() => {
            loading.style.display = 'none';

            if (pendingAlert && pendingAlert.targetedUsers.includes(mobileId)) {
                // SUCCESS: Targeted user receives the alert
                mobileStatus.textContent = `Alert Verified & Received! (Level: ${pendingAlert.alertLevel})`;
                document.getElementById('notification-time').textContent = `Incident: ${pendingAlert.incidentType} (${pendingAlert.timestamp})`;
                document.getElementById('notification-message').textContent = pendingAlert.message;
                notificationBox.classList.remove('hidden');
                document.getElementById('mobile-app-display').classList.add('bg-red-50', 'border-red-400');
            } else if (pendingAlert) {
                // FAILURE: Alert was triggered, but this specific user was not targeted
                mobileStatus.textContent = `No exposure alert for this user. (${pendingAlert.targetedUsers.length} users were targeted.)`;
                notificationBox.classList.add('hidden');
                document.getElementById('mobile-app-display').classList.remove('bg-red-50', 'border-red-400');
            } else {
                // IDLE: No alert has been triggered yet
                mobileStatus.textContent = 'System running in background (Opt-in GPS active)...';
                notificationBox.classList.add('hidden');
                document.getElementById('mobile-app-display').classList.remove('bg-red-50', 'border-red-400');
            }
        }, 1000);
    }

    function clearAlert() {
        document.getElementById('mobile-alert-notification').classList.add('hidden');
        document.getElementById('mobile-status').textContent = 'Alert acknowledged. Monitoring continues.';
        document.getElementById('mobile-app-display').classList.remove('bg-red-50', 'border-red-400');
        // We clear the state to simulate the alert being a one-time push
        pendingAlert = null;
    }

    // Start checking for an alert payload every 3 seconds (simulating secure push/pull background service)
    setInterval(checkAlert, 3000);
</script>
</body>
</html>